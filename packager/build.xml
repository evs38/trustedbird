<?xml version="1.0"?>
<!-- ====================================================================== 
    May 29, 2007 3:27:59 PM                                                        
    
    Milimail Packager    
    
    
    Olivier PARNIERE                                                                
    ====================================================================== -->
<project name="Milimail Packager" default="package-milimail">
    <description>Package All Extensions</description>

    <property file="package.properties" />
    <!-- - - - - - - - - - - - - - - - - - 
        target: load-svn-ant-libray                      
        - - - - - - - - - - - - - - - - - -->
    <target name="load-svn-ant-libray">
        <path id="svnant.classpath">
            <fileset dir="lib">
                <include name="**/*.jar" />
            </fileset>
        </path>

        <typedef resource="org/tigris/subversion/svnant/svnantlib.xml"
            classpath="lib/svnant.jar;lib/svnClientAdapter.jar;lib/svnkit.jar;lib/javahl.jar;lib/ganymed.jar" />
    </target>


    <!-- ================================= 
        target: clean              
        ================================= -->
    <target name="clean" description="--> clean all generated files">
        <delete includeEmptyDirs="true" failonerror="no">
            <fileset dir="${local.repository}" />
            <fileset dir="${local.destination}" />
        </delete>
    </target>

    <!-- ================================= 
        target: prepare-layout              
        ================================= -->
    <target name="prepare-layout" depends="clean"
        description="--> Prepare file layout">
        <mkdir dir="${local.repository}" />
        <mkdir dir="${local.destination}" />
        <mkdir dir="${trunk.mdn.local}" />
        <mkdir dir="${trunk.xsmtp.local}" />
        <mkdir dir="${trunk.gfd.local}" />
        <mkdir dir="${trunk.multildap.local}" />
        <mkdir dir="${trunk.languages.local}" />

        <mkdir dir="${tag.mdn.0110.local}" />
        <mkdir dir="${tag.gfd.0110.local}" />
        <mkdir dir="${tag.dsn.0100.local}" />
        <mkdir dir="${tag.multildap.0101.local}" />

        <mkdir dir="${tag.languages.0100.local}/mozilla" />
    </target>

    <!-- ================================= 
        target: checkout-extensions              
        ================================= -->
    <target name="checkout-extensions"
        depends="prepare-layout,load-svn-ant-libray"
        description="--> checkout all extension from repository">

        <svn username="oparnier" password="Meeshohg" javahl="false"
            svnkit="true">
            <checkout url="${trunk.mdn.url}"
                destpath="${trunk.mdn.local}" />
            <checkout url="${trunk.xsmtp.url}"
                destpath="${trunk.xsmtp.local}" />
            <checkout url="${trunk.gfd.url}"
                destpath="${trunk.gfd.local}" />
            <checkout url="${trunk.multildap.url}"
                destpath="${trunk.multildap.local}" />
            <checkout url="${trunk.languages.url}"
                destpath="${trunk.languages.local}" />

            <checkout url="${tag.mdn.0110.url}"
                destpath="${tag.mdn.0110.local}" />
            <checkout url="${tag.gfd.0110.url}"
                destpath="${tag.gfd.0110.local}" />
            <checkout url="${tag.dsn.0100.url}"
                destpath="${tag.dsn.0100.local}" />
            <checkout url="${tag.languages.0100.url}"
                destpath="${tag.languages.0100.local}" />
            <checkout url="${tag.multildap.0101.url}"
                destpath="${tag.multildap.0101.local}" />
        </svn>

    </target>

    <!-- ================================= 
        target: checkout-milimail              
        ================================= -->
    <target name="checkout-milimail"
        depends="package-extensions,load-svn-ant-libray"
        description="--> checkout milimail">
        <svn javahl="false" svnkit="true">
            <checkout url="${br.th.v0.url}"
                destpath="${br.th.v0.local}" />
        </svn>
    </target>

    <!-- ================================= 
        target: compile-milimail-linux              
        ================================= -->
    <target name="compile-milimail-linux"
        depends="checkout-milimail,copy-config-linux" if="isLinux"
        description="--> compile Milimail">
        <exec executable="make" dir="${br.th.v0.local}">
            <arg value="-f" />
            <arg value="client.mk" />
            <arg value="build" />
        </exec>
    </target>

    <!-- ================================= 
        target: compile-milimail-win              
        ================================= -->
    <target name="compile-milimail-win"
        depends="checkout-milimail,copy-config-win" if="isWin"
        description="--> compile Milimail">
        <exec executable="svn" dir="${br.th.v0.local}">
            <arg value="revert" />
            <arg value="-R ." />
        </exec>
        <exec executable="sh" dir="${br.th.v0.local}">
            <arg value="configure" />
        </exec>
        <exec executable="make" dir="${br.th.v0.local}">
            <arg value="distclean" />
        </exec>
        <exec executable="make" dir="${br.th.v0.local}">
            <arg value="-f" />
            <arg value="client.mk" />
            <arg value="build" />
        </exec>
    </target>

    <!-- ================================= 
        target: package-milimail              
        ================================= -->
    <target name="package-milimail"
        depends="check-os,compile-milimail-linux,compile-milimail-win"
        description="--> package milimail in a compressed archive">
        <exec executable="make" dir="${br.th.v0.local}">
            <arg value="-C" />
            <arg value="xpinstall/packager" />
        </exec>

        <copy todir="${local.destination}">
            <fileset dir="${br.th.v0.local}/dist">
                <include name="*.tar.gz" />
                <include name="*.zip" />
            </fileset>
            <mapper type="regexp" from="(.*)\.(tar\.gz|zip)$"
                to="\1.v0.\2" />
        </copy>
    </target>

    <!-- - - - - - - - - - - - - - - - - - 
        target: check-os                      
        - - - - - - - - - - - - - - - - - -->
    <target name="check-os">
        <condition property="isWin">
            <and>
                <os family="windows" />
            </and>
        </condition>

        <condition property="isLinux">
            <and>
                <os family="unix" />
            </and>
        </condition>
    </target>

    <!-- - - - - - - - - - - - - - - - - - 
        target: copy-config-win                      
        - - - - - - - - - - - - - - - - - -->
    <target name="copy-config-win" depends="check-os">
        <copy file="res/config/win/.mozconfig"
            tofile="${br.th.v0.local}/.mozconfig" />
    </target>

    <!-- - - - - - - - - - - - - - - - - - 
        target: copy-config-linux                      
        - - - - - - - - - - - - - - - - - -->
    <target name="copy-config-linux" depends="check-os">
        <copy file="res/config/linux/.mozconfig"
            tofile="${br.th.v0.local}/.mozconfig" />
    </target>

    <!-- ================================= 
        target: package-extensions              
        ================================= -->
    <target name="package-extensions" depends="checkout-extensions"
        description="--> description">
        <zip destfile="${local.destination}/${trunk.dsn.name}.xpi"
            basedir="${trunk.dsn.local}" excludes="build.xml" />
        <zip destfile="${local.destination}/${trunk.mdn.name}.xpi"
            basedir="${trunk.mdn.local}" />
        <zip destfile="${local.destination}/${trunk.xsmtp.name}.xpi"
            basedir="${trunk.xsmtp.local}" />
        <zip destfile="${local.destination}/${trunk.gfd.name}.xpi"
            basedir="${trunk.gfd.local}" />
        <zip destfile="${local.destination}/${trunk.multildap.name}.xpi"
            basedir="${trunk.multildap.local}" />
        <zip destfile="${local.destination}/${trunk.languages.name}.xpi"
            basedir="${trunk.languages.local}" />

        <zip destfile="${local.destination}/${tag.mdn.0110.name}.xpi"
            basedir="${tag.mdn.0110.local}" />
        <zip destfile="${local.destination}/${tag.gfd.0110.name}.xpi"
            basedir="${tag.mdn.0110.local}" />
        <zip destfile="${local.destination}/${tag.dsn.0100.name}.xpi"
            basedir="${tag.dsn.0100.local}" />
        <zip
            destfile="${local.destination}/${tag.languages.0100.name}.xpi"
            basedir="${tag.languages.0100.local}" />
        <zip
            destfile="${local.destination}/${tag.multildap.0101.name}.xpi"
            basedir="${tag.multildap.0101.local}" />
    </target>




</project>
